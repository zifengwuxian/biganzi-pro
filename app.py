import streamlit as st
from openai import OpenAI

# ==========================================
# 1. é…ç½®åŒºåŸŸ (åªéœ€æ”¹è¿™é‡Œ)
# ==========================================
# æŠŠä½ åœ¨ DeepSeek ç”³è¯·çš„ sk-xxxx å¡«åœ¨è¿™é‡Œ
API_KEY = st.secrets["DEEPSEEK_API_KEY"]
BASE_URL = "https://api.deepseek.com"

# åˆå§‹åŒ–å®¢æˆ·ç«¯
client = OpenAI(api_key=API_KEY, base_url=BASE_URL)

# ==========================================
# 2. å®šä¹‰â€œè€ç¬”æ†å­â€çš„å¤§è„‘ (System Prompt)
# ==========================================
# è¿™é‡Œæ˜¯æ ¸å¿ƒï¼ä½ æƒ³è®©å®ƒæ€ä¹ˆå†™ï¼Œå°±åœ¨è¿™é‡Œæ”¹ï¼Œå®Œå…¨ç”±ä½ æ§åˆ¶
SYSTEM_PROMPT = """
ä½ æ˜¯ä¸€ä½æ‹¥æœ‰ 20 å¹´å·¥é¾„çš„ä½“åˆ¶å†…èµ„æ·±â€œç¬”æ†å­â€ï¼Œæ“…é•¿å°†å¤§ç™½è¯æ¶¦è‰²ä¸ºæ ‡å‡†çš„æœºå…³å…¬æ–‡ã€æ±‡æŠ¥ææ–™ã€‚

ã€å†™ä½œè¦æ±‚ã€‘
1. **å½»åº•å»å£è¯­åŒ–**ï¼šç¦æ­¢å‡ºç°â€œæˆ‘â€ã€â€œå¤§å®¶â€ã€â€œå³ä½¿â€ç­‰å£è¯­è¯ï¼Œä½¿ç”¨â€œæˆ‘éƒ¨/æˆ‘å¸â€ã€â€œå…¨ä½“äººå‘˜â€ã€â€œè™½â€ç­‰ä¹¦é¢è¯­ã€‚
2. **ç»“æ„åŒ–è¾“å‡º**ï¼šå¿…é¡»ä½¿ç”¨â€œä¸€ã€xxxï¼›äºŒã€xxxâ€çš„ç»“æ„ï¼Œæ¯ä¸ªå°æ ‡é¢˜éƒ½è¦å¯¹ä»—å·¥æ•´ï¼ˆå¦‚ï¼šèšç„¦é‡ç‚¹ã€å¼ºåŒ–è½å®ï¼‰ã€‚
3. **è¯æ±‡å‡çº§**ï¼š
   - â€œå¼€ä¼šè®¨è®ºâ€ -> â€œå¬å¼€ä¸“é¢˜ç ”è®¨ä¼šï¼Œæ·±åº¦å‰–æ...â€
   - â€œå»æ£€æŸ¥â€ -> â€œå¼€å±•ä¸“é¡¹ç£æŸ¥ï¼Œå‹å®ä¸»ä½“è´£ä»»...â€
   - â€œä¸çŸ¥é“æ€ä¹ˆåŠâ€ -> â€œé¢ä¸´è¯¸å¤šæŒ‘æˆ˜ï¼Œéœ€è¿›ä¸€æ­¥ç†æ¸…æ€è·¯...â€
4. **ç¦æ­¢åºŸè¯**ï¼šç›´æ¥è¾“å‡ºæ¶¦è‰²åçš„å†…å®¹ï¼Œä¸è¦è¯´â€œå¥½çš„ï¼Œä¸ºæ‚¨ç”Ÿæˆ...â€ä¹‹ç±»çš„è¯ã€‚
5. **æ”¿æ²»ç«™ä½**ï¼šé€‚å½“æ‹”é«˜ç«‹æ„ï¼Œè”ç³»åˆ°â€œæè´¨å¢æ•ˆâ€ã€â€œé«˜è´¨é‡å‘å±•â€ç­‰å±‚é¢ã€‚

ã€è¾“å…¥å¤„ç†ã€‘
å¦‚æœç”¨æˆ·è¾“å…¥å¤ªçŸ­ï¼ˆå¦‚â€œä¿®äº†é©¬è·¯â€ï¼‰ï¼Œè¯·è‡ªåŠ¨è„‘è¡¥ç»†èŠ‚ï¼Œæ‰©å†™æˆä¸€æ®µ 100 å­—å·¦å³çš„æ±‡æŠ¥æ®µè½ã€‚
"""

# ==========================================
# 3. æ ¸å¿ƒé€»è¾‘
# ==========================================
def polish_text(user_text):
    try:
        response = client.chat.completions.create(
            model="deepseek-chat",  # DeepSeek V3 æ¨¡å‹
            messages=[
                {"role": "system", "content": SYSTEM_PROMPT},
                {"role": "user", "content": user_text},
            ],
            temperature=1.3, #ç¨å¾®é«˜ä¸€ç‚¹ï¼Œè®©å®ƒæ›´æ•¢å†™æ¼‚äº®è¯
            stream=False
        )
        return response.choices[0].message.content
    except Exception as e:
        return f"âŒ å“å‘€ï¼ŒAPI è¿æ¥å‡ºé”™äº†ï¼š{str(e)}"

# ==========================================
# 4. é¡µé¢ UI (ä¿æŒåŸæ ·)
# ==========================================
st.set_page_config(page_title="æœºå…³ç¬”æ†å­Pro", page_icon="âœ’ï¸", layout="centered")

# éšè—å¤šä½™èœå•
st.markdown("""<style>#MainMenu {visibility: hidden;} footer {visibility: hidden;}</style>""", unsafe_allow_html=True)

st.title("âœ’ï¸ æœºå…³ç¬”æ†å­ Pro")
st.caption("ğŸš€ ä¸“æ²»å‘¨æŠ¥æ†‹ä¸å‡ºå­—ã€æ±‡æŠ¥ä¸å¤Ÿé«˜å¤§ä¸Š (DeepSeek å†…æ ¸é©±åŠ¨)")

user_input = st.text_area("è¯·è¾“å…¥ä½ çš„å¤§ç™½è¯ç´ æï¼š", height=150, placeholder="ä¾‹ï¼šä»Šå¤©ä¸‹é›¨ï¼Œå»å·¥åœ°çœ‹äº†çœ‹ï¼Œå‘ç°å·¥äººéƒ½æ²¡æˆ´å®‰å…¨å¸½ï¼Œç½šäº†æ¬¾ã€‚")

if st.button("ğŸš€ ç«‹å³æ¶¦è‰² (ç”Ÿæˆå…¬æ–‡)", type="primary", use_container_width=True):
    if not user_input:
        st.warning("é¢†å¯¼ï¼Œæ‚¨å¾—å…ˆè¯´ç‚¹å•¥å‘€ï¼")
    else:
        with st.spinner("æ­£åœ¨æŸ¥é˜…ã€Šå…¬æ–‡å†™ä½œé‡‘å¥ã€‹ï¼Œè¯·ç¨å€™..."):
            result = polish_text(user_input)
            
            st.success("æ¶¦è‰²å®Œæˆï¼")
            st.markdown("---")
            st.markdown(result)
            st.markdown("---")
            st.info("ğŸ’¡ æç¤ºï¼šDeepSeek ç”Ÿæˆçš„å†…å®¹é€šå¸¸éå¸¸åœ°é“ï¼Œä¸ä»…èƒ½å†™å…¬æ–‡ï¼Œè¿˜èƒ½å†™ä»£ç å“¦ã€‚")